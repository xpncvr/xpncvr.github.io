<!doctype html>
<html>
  <head>
    <style>
      .body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #1e1e1e;
        color: #fff;
      }

      .button {
        padding: 10px 20px;
        background-color: #5865f2;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .button:hover {
        background-color: #434cba;
      }

      .mode-select {
        margin-bottom: 30px;
      }

      .label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }

      .input-text {
        width: 95%;
        padding: 8px;
        margin-top: 4px;
        margin-bottom: 15px;
        border: 1px solid #555;
        border-radius: 4px;
        background-color: #2e2e2e;
        color: white;
        box-sizing: border-box;
      }

      .input-time {
        border: 1px solid #555;
        border-radius: 4px;
        background-color: #2e2e2e;
        color: white;
      }

      .user-list {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .user {
        display: flex;
        align-items: center;
        background-color: #333;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .user:hover {
        background-color: #444;
      }

      .user-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .plus-user {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #333;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .plus-user:hover {
        background-color: #444;
      }

      .form {
        margin-bottom: 20px;
      }

      .hidden {
        display: none;
      }

      .remove-user {
        color: #aaa;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 10px;
        font-size: 13px;
      }

      .remove-user:hover {
        color: #ccc;
      }

      .username-prompt {
        margin-bottom: 10px;
        font-style: italic;
        font-size: 15px;
        color: #bbb;
      }
    </style>
  </head>
  <body class="body">
    <div class="mode-select">
      <button class="button" onclick="setMode('any')">Any mode</button>
      <button class="button" onclick="setMode('talking')">One on one mode</button>
    </div>

    <div class="user-list"></div>

    <div class="form create-user-form hidden">
      <h2>Add User</h2>
      <div class="username-prompt hidden"></div>

      <label class="label">Image URL:</label>
      <input class="input-text url-input" type="text" />

      <label class="label">Name:</label>
      <input class="input-text name-input" type="text" />
      <br />
      <button class="button" onclick="createUser()">Create User</button>
    </div>

    <div class="form send-message-form hidden">
      <h2>Send Message</h2>
      <label class="label">Message:</label>
      <input class="input-text message-input" type="text" />
      <label class="label">Time:</label>
      <input class="input-time time-input" type="time" />
      <button class="button" onclick="sendMessage()">Send</button>
      <div class="remove-user" onclick="removeUser()">Remove User</div>
    </div>

    <script>
      const users = [];
      let selectedUser = null;
      let mode = null;
      let userCount = 0;

      const modeSelect = document.querySelector(".mode-select");
      const userList = document.querySelector(".user-list");
      const createUserForm = document.querySelector(".create-user-form");
      const sendMessageForm = document.querySelector(".send-message-form");
      const usernamePrompt = document.querySelector(".username-prompt");
      const urlInput = document.querySelector(".url-input");
      const nameInput = document.querySelector(".name-input");
      const messageInput = document.querySelector(".message-input");
      const timeInput = document.querySelector(".time-input");

      function setMode(selectedMode) {
        mode = selectedMode;
        modeSelect.classList.add("hidden");
        createUserForm.classList.remove("hidden");

        if (mode === "talking") {
          userCount = 0;
          promptNextUser();
        }
      }

      function promptNextUser() {
        usernamePrompt.textContent = userCount === 0 ? "What is your username?" : "Enter another user's name:";
        usernamePrompt.classList.remove("hidden");
        urlInput.value = "";
        nameInput.value = "";
      }

      function createUser() {
        const url = urlInput.value;
        const name = nameInput.value;
        if (!url || !name) return;

        const id = Date.now() + userCount;
        users.push({ url, name, id });
        renderUsers();

        if (mode === "talking") {
          userCount++;
          if (userCount === 1) {
            initSelfUser(name, url);
            promptNextUser();
          } else {
            initUser(name, url);
            createUserForm.classList.add("hidden");
            usernamePrompt.classList.add("hidden");
          }
        } else {
          usernamePrompt.classList.add("hidden");
        }

        urlInput.value = "";
        nameInput.value = "";
      }

      function renderUsers() {
        userList.innerHTML = "";

        const plus = document.createElement("div");
        plus.className = "plus-user";
        plus.textContent = "+";
        plus.onclick = () => {
          selectedUser = null;
          sendMessageForm.classList.add("hidden");
          createUserForm.classList.remove("hidden");
        };
        userList.appendChild(plus);

        users.forEach((user, index) => {
          const div = document.createElement("div");
          div.className = "user";
          div.innerHTML = `<img class="user-avatar" src="${user.url}"><span>${user.name}</span>`;
          div.onclick = () => selectUser(index);
          userList.appendChild(div);
        });
      }

      function selectUser(index) {
        selectedUser = users[index];
        createUserForm.classList.add("hidden");
        sendMessageForm.classList.remove("hidden");
        setDefaultTime();

        messageInput.focus();
        messageInput.onkeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
            messageInput.focus();
          }
        };
      }

      function sendMessage() {
        if (!selectedUser || !messageInput.value) return;

        window.opener.postMessage(
          {
            type: "injectMessage",
            url: selectedUser.url,
            name: selectedUser.name,
            message: messageInput.value,
            id: selectedUser.id,
            time: timeInput.value,
          },
          "*",
        );

        messageInput.value = "";
      }

      function initUser(name, url) {
        window.opener.postMessage({ type: "initUser", name, url }, "*");
      }

      function initSelfUser(name, url) {
        window.opener.postMessage({ type: "initSelfUser", name, url }, "*");
      }

      function removeUser() {
        if (!selectedUser) return;
        const i = users.findIndex((u) => u.id === selectedUser.id);
        if (i > -1) users.splice(i, 1);
        selectedUser = null;
        renderUsers();
        sendMessageForm.classList.add("hidden");
        createUserForm.classList.remove("hidden");
      }

      function setDefaultTime() {
        const now = new Date();
        timeInput.value = now.getHours().toString().padStart(2, "0") + ":" + now.getMinutes().toString().padStart(2, "0");
      }
    </script>
  </body>
</html>
